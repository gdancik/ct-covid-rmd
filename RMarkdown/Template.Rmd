---
title: "`r params$data` - CT COVID 19 Data"
output:
  flexdashboard::flex_dashboard:
    favicon: https://hubcdn.arcgis.com/opendata-ui/assets/assets/images/favicon-45a5f6cdc7f23c52b20204d54a7d9ca2.ico
    navbar:
    - { title: "Home",          href: "", align: left }
    - { title: "Projections",   href: "", align: left }
    - { title: "Statewide Data",href: "", align: left }
    - { title: "County Data",   href: "./county.html", align: left }
    - { title: "Age Data",      href: "", align: left }
    - { title: "Gender Data",   href: "", align: left }
    - { title: "Email Sign-up", href: "", align: left }
    - { title: "About",         href: "", align: left }
    orientation: rows
    vertical_layout: scroll
params:
    data: "Hartford"
    devp: "n"
editor_options: 
  chunk_output_type: console
---
```{r setup, include=FALSE}

# include libraries
library(flexdashboard)
library(readr)
library(dplyr)
library(ggplot2)
library(knitr)
library(zoo) # moving averages

# get the data - leave for quick testing one file
load("../data/covid.RData")
covid <- covid %>% arrange(dateupdated)

# Filters the data for a specified county, which is specified as a parameter
# in the R Markdown file, and graphs the number of cases for this county ovr time.
covid_county <- covid %>% filter(county == params$data)

# get date range
beginDate <- format.Date(first(covid$dateupdated), '%m/%d/%Y')
lastDate <- format.Date(last(covid$dateupdated), '%m/%d/%Y')

cases <- last(covid_county$totalcases)
deaths <- last(covid_county$totaldeaths)

# Daily Cases along with its bar graph
cases1 <- covid_county$totalcases
daily_cases <- diff(cases1)
daily_cases <- replace(daily_cases, daily_cases < 0, 0)
daily_cases <- cbind(TotalCases = c(0,daily_cases))

# Daily deaths along with its bar graph
deaths1 <- covid_county$totaldeaths
daily_deaths <- diff(deaths1)
daily_deaths <- replace(daily_deaths, daily_deaths < 0, 0)
daily_deaths <- cbind(TotalDeaths = c(0,daily_deaths))

# Hospitalizations
hospitalizations <- last(covid_county$hospitalization)

# 30 day highest case 
highest_30day_cases <- max(daily_cases[(length(daily_cases)-30):length(daily_cases)])

# 30 day highest deaths
highest_30day_deaths <- max(daily_deaths[(length(daily_deaths)-30):length(daily_deaths)])

```

```{css, echo=FALSE}
.current {
  background-color: maroon;
}

.blue {
  text-decoration: none;
  color: #ffffff !important;
  background-color: #2780e3;
}

button.dropdown-toggle {
  color: #ffffff;
  background-color: #2780e3;
  font-size: large;
}

.center {
  margin: auto;
  /*border: 3px solid #73AD21;*/
  /*padding: 3px;*/
  text-align: center;
```

<script>
// wait for the page to load to do this, can't select elements that aren't loaded yet.

window.onload = function () {

  // console.log("We are executing on load");
  
  var list = document.querySelectorAll(".navbar-left > li > a");
  
  for (i=0; i<list.length; i++)
  {
    var x = list[i];
    //console.log(x.innerHTML);
    if (x.innerHTML == "County Data")
    {
      x.classList.add("current"); // assign the current class to the current tab
    }
  }
  
  var ddlist = document.querySelectorAll(".dropdown-menu > li > a");
  
  for (i=0; i<ddlist.length; i++)
  {
    var x = ddlist[i];
    //console.log(x.innerHTML);
    if (x.innerHTML == "`r params$data`")
    {
      x.classList.add("blue"); // assign the current class to the current tab
    }
  }
}
</script>

<ul class="nav" role="tablist">
    <li class="dropdown">
        <button class="dropdown-toggle" data-toggle="dropdown" aria-expanded="false">Counties<span class="caret"></span></button>
        <ul class="dropdown-menu">
            <li><a href="./New London.html">New London</a></li>
            <li><a href="./New Haven.html" >New Haven</a></li>
            <li><a href="./Fairfield.html" >Fairfield</a></li>
            <li><a href="./Hartford.html"  >Hartford</a></li>
            <li><a href="./Tolland.html"   >Tolland</a></li>
            <li><a href="./Litchfield.html">Litchfield</a></li>
            <li><a href="./Middlesex.html" >Middlesex</a></li>
            <li><a href="./Windham.html"   >Windham</a></li>
        </ul>
    </li>
</ul>

<div class="center">
### *This page contains COVID-19 information for **`r params$data`, CT** from `r beginDate ` to `r lastDate`.*
</div>

Row
----------------------------------------------------------------------

### Total Number of cases

```{r}
valueBox(cases, icon = "fa-folder-open")
```

### Total Number of deaths

```{r}
valueBox(deaths, icon = "ion-ios-medical")
```

### Current Hospitalizations

```{r, echo=FALSE, message=FALSE}
if (hospitalizations > 20) {
  boxcolor <- "danger"
} else if (hospitalizations > 10) {
  boxcolor <- "warning"
} else {
  boxcolor <- "primary"
}

valueBox(hospitalizations, icon = "fa-first-aid", color = boxcolor)
```

Row{data-height=600px}
-----------------------------------------------------------------------

### Cases per Day

```{r, echo=FALSE, message=FALSE}
# 7 day average for cases
seven_case_avg <- rollmean(daily_cases, k = 7, fill = 0)
df <- data.frame(daily_cases,covid_county$dateupdated)

barcases <- ggplot(data = df, aes(x=covid_county.dateupdated ,y = TotalCases, )) +
geom_bar(stat = "identity", fill="steelblue") + theme(legend.position = "none") + labs(x = " ", y = "Cases") + geom_line(aes(y = seven_case_avg), size = 1, color="red", group = 1)

barcases
```

### Deaths per Day

```{r, echo=FALSE, message=FALSE}
# 7 day average for deaths
seven_death_avg <- rollmean(daily_deaths, k = 7, fill = 0)
death_df <- data.frame(daily_deaths,covid_county$dateupdated)

bar_deaths <- ggplot(data = death_df, aes(x=covid_county.dateupdated ,y = TotalDeaths)) +
geom_bar(stat="identity", fill="black") + theme(legend.position = "none") + labs(x = " ", y = "Deaths") + geom_line(aes(y = seven_death_avg), size = 1, color="red", group = 1)

bar_deaths
```

### Hospitalizations per Day

```{r, echo=FALSE, message=FALSE}
# Daily hospitalizations and its graph
# 7 day average for hospitalizations
seven_hosp_avg <- rollmean(covid_county$hospitalization,k=7,fill=NA)

bar_hospitilization <- ggplot(data = covid_county, aes(x = dateupdated , y = hospitalization)) +
geom_bar(stat="identity", fill="orange") + theme(legend.position = "none") + labs(x = " ", y = "Hospitalizations") + geom_line(aes(y = seven_hosp_avg), size = 1, color="red", group = 1)

bar_hospitilization
```

Row {data-height=150px}
-----------------------------------------------------------------------
### Latest Daily Cases (30 day high = `r highest_30day_cases`)

```{r, echo=FALSE, message=FALSE}
previous_daily_case <- daily_cases[length(daily_cases)]
gauge(previous_daily_case, min = 0, max = highest_30day_cases, symbol = '', gaugeSectors(
success = c(0,highest_30day_cases), colors=c("primary")
))
```

### Latest Daily Deaths (30 day high = `r highest_30day_deaths`) 

```{r, echo=FALSE, message=FALSE}
previous_daily_deaths <- daily_deaths[length(daily_deaths)]
gauge(previous_daily_deaths, min = 0, max = highest_30day_deaths, symbol = '', gaugeSectors(
success = c(0, highest_30day_deaths),colors = c("black")
))
```

<!-- Maybe we can embed this with r code 
<div align="right">
**Created by B. Gonzalez and S. Yraita in support of EIDA's [CT COVID Data Analysis](https://eida.easternct.edu/shiny/app/covid-ct) project.**
</div>
-->
